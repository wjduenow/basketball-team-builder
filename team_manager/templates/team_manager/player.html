{% include 'team_manager/partial-user-menu.html' %}


    <ol class="breadcrumb">
        <li><a href="/">Home</a></li>
        <li><a href="/players">Players</a></li>
        <li class="active">Player</li>
    </ol>

 <!-- main content -->
<div class="container theme-showcase" role="main">

  <div class="page-header">
        <h1>Player: {{player}}</h1>
  </div>

    <div class="row">

        <div class="col-sm-13">
            <div class="list-group" id="list2">


                <div class="panel panel-default">
                    <div class="panel-heading">
                            <h3 class="panel-title">{{ player }}</h3>
                    </div>

                    <div class="panel-body" id="{{team}}">
                            <div id="player_{{player.id}}" class="list-group-item player">
                                <strong>First Name: </strong>{{player.first_name}}
                            </div>
                            <div id="player_{{player.id}}" class="list-group-item player">
                                <strong>Last Name: </strong>{{player.last_name}}
                            </div>
                            <div id="player_{{player.id}}" class="list-group-item player">
                                <strong>Nickname: </strong>{{player.nick_name}}
                            </div>
                            <div id="player_{{player.id}}" class="list-group-item player">
                                <strong>Position: </strong>{{player.position}}
                            </div>
                            <div id="player_{{player.id}}" class="list-group-item player">
                                <strong>Status: </strong> {{player.status}}
                            </div>
                            <div id="player_{{player.id}}" class="list-group-item player">
                                <strong>Size: </strong>
                                {% if player.size == 1 %}
                                    Small
                                {% elif player.size == 2 %}
                                    Medium
                                {% else %}
                                    Large
                                {% endif %}
                            </div>
                            <div id="player_{{player.id}}" class="list-group-item player">
                                <strong>Ball Handler: </strong>
                                {% if player.ball_handler %}
                                    <span class="glyphicon glyphicon-ok-circle" aria-hidden="true"></span> 
                                {% else %}
                                    <span class="glyphicon glyphicon-ban-circle" aria-hidden="true"></span> 
                                {% endif %}
                            </div>

                    </div>


                    <div class="panel-footer">
                    {% if user.is_superuser %}
                      <a href="/edit_player/{{player.id}}">
                            <button class="btn btn-success btn-sm" type="submit" name="action">Edit
                                <span class="glyphicon glyphicon-edit" aria-hidden="true"></span>
                            </button>
                      </a>
                     {% endif %}
                    </div>

                </div>
            </div>
        </div>
    </div> <!-- End Row -->


    <div class="row">
      <div class="col-sm-12 well" id="win_loss_well">
        <h5 class="g-hed" id="win_loss_head"></h5>
        <p class="g-intro" id="win_loss_intro"></p>
        <div id="win_loss_chart"></div>
      </div>
    </div>


    <div class="row">
      <div class="col-sm-12 well" id="point_differential_well">
        <h5 class="g-hed" id="point_differential_head"></h5>
        <p class="g-intro" id="point_differential_intro"></p>
        <div id="point_differential_chart"></div>
      </div>
    </div>


    <div class="row">

      <div class="col-sm-12 well">
      <h5 class="g-hed">Players Played With</h5>
        <table data-toggle="table" class="table table-condensed table-striped table table-bordered">
            <thead>
              <tr>
                  <th class="td-name" data-sortable="true">Name</th>
                  <th class="td-name" data-sortable="true">P</th>
                  <th class="td-name" data-sortable="true">W</th>
                  <th class="td-name" data-sortable="true">Ratio</th>
                  <th class="td-name" data-sortable="true">Diff</th>
                  <th class="td-name" data-sortable="true">MS</th>
                </tr>
              </thead>
          {% for ps in player.player_player_summary.all %}
              {% if ps.other_player.id != player.id %}
                <tr>
                  <td>{{ps.other_player}}</td>
                  <td>{{ps.played}}</td>
                  <td>{{ps.won}}</td>
                  <td>{{ps.win_loss|floatformat:2}}</td>
                  <td>{{ps.point_differential|floatformat:2}}</td>
                  <td>{{ps.meta_score|floatformat:2}}</td>
                </tr>
              {% endif %}
          {% endfor %}
        </table>
      </div>
    </div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js" charset="utf-8"></script>
<script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>

<script>
//Margin conventions
var margin = {top: 40, right: 70, bottom: 40, left: 35};

//var widther = window.outerWidth;

var element = d3.select('#point_differential_well').node();
var widther = element.getBoundingClientRect().width;

var width = widther - margin.left - margin.right,
    height = 400 - margin.top - margin.bottom;

//Parses date for correct time format
var parseDate = d3.time.format("%Y-%m-%d").parse;

//Divides date for tooltip placement
var bisectDate = d3.bisector(function(d) { return d.date; }).left;    

//Appends the svg to the chart-container div
var svg = d3.select("#point_differential_chart").append("svg")
  .attr("width", width + margin.left + margin.right)
  .attr("height", height + margin.top + margin.bottom)
  .attr("id", "point_differential_svg")
  .append("g")
  .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

//Appends the svg to the chart-container div
var svg2 = d3.select("#win_loss_chart").append("svg")
  .attr("width", width + margin.left + margin.right)
  .attr("height", height + margin.top + margin.bottom)
  .attr("id", "win_loss_svg")
  .append("g")
  .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


//Creates the xScale 
var xScale = d3.time.scale()
  .range([0, width]);

//Creates the yScale
var yScale = d3.scale.linear()
  .range([height, 0]);

var yScale2 = d3.scale.linear()
  .range([height, 0]);

//Defines the y axis styles
var yAxis = d3.svg.axis()
  .scale(yScale)
  .tickSize(-width)
  .tickPadding(8)
  .orient("left");


var yAxis2 = d3.svg.axis()
  .scale(yScale2)
  .tickSize(-width)
  .tickPadding(8)
  .orient("left");

//Defines the y axis styles
var xAxis = d3.svg.axis()
  .scale(xScale)
  .tickPadding(8)
  .orient("bottom")
  .tickSize(height)
  .ticks(numTicks(width))
  .tickFormat(d3.time.format("%Y-%m-%d")); 

//line function convention (feeds an array)
var line = d3.svg.line()
  .x(function(d) { return xScale(d.date); })
  .y(function(d) { return yScale(d.num); });    

var line2 = d3.svg.line()
  .x(function(d) { return xScale(d.date); })
  .y(function(d) { return yScale(d.win_loss); });  

//Loads the data
//d3.csv("linetemplate.csv", ready);
d3.json("/player_win_loss/{{player.id}}", ready);

function ready(err, data) {

  if(err) { console.log(err); }

  if (d3.selectAll(data).size() < 1) {
    d3.select("#point_differential_well").remove();
    d3.select("#win_loss_well").remove();
  }
  console.log("hello");

  //FORMAT data
  data.forEach(function(d) {
    d.num = +d.point_differential;
    d.win_loss = +d.win_loss;
    d.date = parseDate(d.game_date);
  });

  //d3.select("#point_differential_well").remove();
  console.log(data);

  //Appends chart headline
  d3.select("#point_differential_head").text("Game Point Differential");
  d3.select("#win_loss_head").text("Win Loss Ratio");

  //Appends chart intro text
  d3.select("#point_differential_intro").text("");
  d3.select("#win_loss_intro").text("");

  data.sort(function(a,b) { return a.date - b.date; });

  //Defines the xScale max
  xScale.domain(d3.extent(data, function(d) { return d.date; }));

  //Defines the yScale max
  yScale.domain(d3.extent(data, function(d) { return d.num; }));
  yScale2.domain(d3.extent(data, function(d) { return d.win_loss; }));

  //Appends the y axis
  var yAxisGroup = svg.append("g")
    .attr("class", "y axis")
    .call(yAxis);

  var yAxisGroup = svg2.append("g")
    .attr("class", "y axis")
    .call(yAxis2);

  //Appends the x axis    
  var xAxisGroup = svg.append("g")
    .attr("class", "x axis")
    .call(xAxis);

  var xAxisGroup = svg2.append("g")
    .attr("class", "x axis")
    .call(xAxis);

  //Binds the data to the line
  var drawline = svg.append("path")
    .datum(data)
    .attr("class", "line")
    .attr("id", "point_differential_line")
    .attr("d", line); 

  var drawline = svg2.append("path")
    .datum(data)
    .attr("class", "line")
    .attr("id", "win_loss_line")
    .attr("d", line2);  

  //Tooltips
  var focus = svg.append("g")
      .attr("class", "focus")
      .style("display", "none");

  //Adds circle to focus point on line
  focus.append("circle")
      .attr("r", 4);

  //Adds text to focus point on line    
  focus.append("text")
      .attr("x", 9)
      .attr("dy", ".35em");    
  
  //Creates larger area for tooltip   
  var overlay = svg.append("rect")
      .attr("class", "overlay")
      .attr("width", width)
      .attr("height", height)
      .on("mouseover", function() { focus.style("display", null); })
      .on("mouseout", function() { focus.style("display", "none"); })
      .on("mousemove", mousemove);
  
  //Tooltip mouseovers            
  function mousemove() {
    var x0 = xScale.invert(d3.mouse(this)[0]),
        i = bisectDate(data, x0, 1),
        d0 = data[i - 1],
        d1 = data[i],
        d = x0 - d0.date > d1.date - x0 ? d1 : d0;
    focus.attr("transform", "translate(" + xScale(d.date) + "," + yScale(d.num) + ")");
    focus.select("text").text(d.num);
  }; 

      
  //RESPONSIVENESS
  d3.select(window).on("resize", resized);

  function resized() {

    //new margin
    var newMargin = {top: 10, right: 80, bottom: 20, left: 50};

    //Get the width of the window
    var w = d3.select("#point_differential_well").node().clientWidth;
    console.log("resized", w);

    //Change the width of the svg
    d3.select("svg#point_differential_svg")
      .attr("width", w);

    d3.select("svg#win_loss_svg")
      .attr("width", w);

    //Change the xScale
    xScale
      .range([0, w - newMargin.right]);

    //Update the line
    line1 = d3.svg.line()
      .x(function(d) { return xScale(d.date); })
      .y(function(d) { return yScale(d.num); }); 


    line2 = d3.svg.line()
      .x(function(d) { return xScale(d.date); })
      .y(function(d) { return yScale(d.win_loss); }); 

    d3.selectAll('#point_differential_line')
      .attr("d", line1);  

    d3.selectAll('#win_loss_line')
      .attr("d", line2); 


    //Updates xAxis
    xAxisGroup
      .call(xAxis);   

    //Updates ticks
    xAxis
      .scale(xScale)
      .ticks(numTicks(w));

    //Updates yAxis  
    yAxis
      .tickSize(-w - newMargin.right)
  };

}

//Determines number of ticks base on width
function numTicks(widther) {
  if (widther <= 900) {
    return 4
    console.log("return 4")
  }
  else {
    return 12
    console.log("return 5")
  }
}

</script>

    </div>


</div>


    <!-- Latest compiled and minified JavaScript -->
        <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script src="//cdn.rawgit.com/hilios/jQuery.countdown/2.2.0/dist/jquery.countdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.1/bootstrap-table.min.js"></script>

<script type="text/javascript">

    $('#clock').countdown("{{game_end|date:"Y/m/d H:i:s"}}", {elapse: true})
        .on('update.countdown', function(event) {
      var $this = $(this);
      if (event.elapsed) {
        $this.html(event.strftime('OverTime: <span>%H Hours %M Minutes %S Seconds</span>'));
      } else {
        $this.html(event.strftime('Time Remaining: <span>%H Hours %M Minutes %S Seconds</span>'));
      }
    });



  $('#btn-reset').click(function() {
    $clock.countdown(get15dayFromNow());
  });

  $('#btn-pause').click(function() {
    $clock.countdown('pause');
  });

  $('#btn-resume').click(function() {
    $clock.countdown('resume');
  });

</script>

  </body>
</html>